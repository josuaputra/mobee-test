name: Staging Deployment
on:
  push:
    branches:
      - master
jobs:
  build:
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Authenticate to AWS EKS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1  # Update to your AWS region
      - name: Set Image Tag
        id: set_image_tag
        run: |
          # Get the current date and time to use as a tag
          TIMESTAMP=$(date +'%Y%m%d%H%M%S')
          # Set the image tag (you can customize this)
          IMAGE_TAG="myapp:${TIMESTAMP}"
          # Output the image tag as a GitHub Actions output
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
      - name: Build and push Docker image
        run: |
          echo "Building Docker image..."
          docker build -t ${{ secrets.ECR_REPOSITORY_URL }}:${IMAGE_TAG} .
          echo "Logging into ECR..."
          aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin ${{ secrets.ECR_REPOSITORY_URL }}
          echo "Pushing Docker image..."
          docker push ${{ secrets.ECR_REPOSITORY_URL }}:${IMAGE_TAG}
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x ./kubectl
          sudo mv ./kubectl /usr/local/bin/kubectl
      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Authenticate to AWS EKS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1  # Update to your AWS region
      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig --name pismo-uat-cluster --region ap-south-1
      - name: Deploy to EKS
        run: |
          # If using kustomize:
          cd ./k8s/overlays/staging
          kustomize edit set image image-tag=${{ secrets.ECR_REPOSITORY_URL }}:${IMAGE_TAG}
          kustomize build --load-restrictor=LoadRestrictionsNone | kubectl apply -f -