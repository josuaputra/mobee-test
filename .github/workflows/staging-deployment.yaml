name: Staging Deployment
on:
  push:
    branches:
      - main
jobs:
  build:
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: 'projects/714008539838/locations/global/workloadIdentityPools/github-action/providers/github'
          service_account: 'github-ci-sa@sqe-non-prod.iam.gserviceaccount.com'
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      - name: Configure Docker to use the gcloud command-line tool as a credential helper
        run: |-
          # Set up docker to authenticate
          # via gcloud command-line tool.
          gcloud auth configure-docker
          gcloud auth list
      - name: Login to GCR
        run: |-
          # Login to Google Container Registry
          gcloud auth configure-docker asia-southeast2-docker.pkg.dev
      - name: Build Docker Image
        run: |-
          # Build the Docker image
          docker build \
          --build-arg service_type="rest" \
          --build-arg service_env="staging" \
          -t asia-southeast2-docker.pkg.dev/sqe-non-prod/sqekyc/staging/backend:${{ github.sha }} .
      - name: Push Docker Image to GCR
        run: |-
          # Push the Docker image to Google Container Registry
          docker push asia-southeast2-docker.pkg.dev/sqe-non-prod/sqekyc/staging/backend:${{ github.sha }}
  deploy:
    name: Deploy to GKE
    needs: build
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: 'projects/714008539838/locations/global/workloadIdentityPools/github-action/providers/github'
          service_account: 'github-ci-sa@sqe-non-prod.iam.gserviceaccount.com'
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      - name: Configure Docker to use the gcloud command-line tool as a credential helper
        run: |-
          # Set up docker to authenticate
          # via gcloud command-line tool.
          gcloud auth configure-docker
          gcloud auth list
      - name: Deploy to GKE
        run: |-
          # Set the compute zone
          gcloud components install gke-gcloud-auth-plugin
          gcloud config set compute/zone asia-southeast2
          # Set the project
          gcloud config set project sqe-non-prod
          # Set the cluster
          gcloud container clusters get-credentials sqe-non-production-gke-cluster
          # Deploy the Docker image to the cluster
          kubectl set image deployment/sqekyc sqekyc=asia-southeast2-docker.pkg.dev/sqe-non-prod/sqekyc/staging/backend:${{ github.sha }} -n sqekyc-staging
          kubectl set image deployment/sqekyc-cron sqekyc=asia-southeast2-docker.pkg.dev/sqe-non-prod/sqekyc/staging/backend:${{ github.sha }} -n sqekyc-staging
          kubectl set image deployment/sqekyc-consumer sqekyc=asia-southeast2-docker.pkg.dev/sqe-non-prod/sqekyc/staging/backend:${{ github.sha }} -n sqekyc-staging
          # Wait for the rollout to complete
          kubectl rollout status deployment/sqekyc -n sqekyc-staging
          kubectl rollout status deployment/sqekyc-cron -n sqekyc-staging
          kubectl rollout status deployment/sqekyc-consumer -n sqekyc-staging